// DEV - firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Funciones auxiliares de validación
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isValidRating() {
      return request.resource.data.rating is number &&
             request.resource.data.rating >= 0 &&
             request.resource.data.rating <= 5;
    }

    // ----- ESTACIONES -----
    match /estaciones/{estacionId} {
      // Cualquiera puede leer las estaciones
      allow read: if true;
      
      // Solo los administradores pueden crear/borrar estaciones
      allow create, delete: if isAdmin();
      
      // Permitir actualizar solo los campos de rating
      allow update: if isAuthenticated() &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['rating', 'totalRatings', 'updatedAt']) ||
        isAdmin();
        
      // Subcolección de ratings
      match /ratings/{ratingId} {
        // Cualquiera puede ver los ratings
        allow read: if true;
        
        // Solo usuarios autenticados y verificados pueden crear/actualizar su propio rating
        allow create: if isAuthenticated() && isEmailVerified() &&
          ratingId == request.auth.uid &&
          request.resource.data.keys().hasAll(['rating', 'userId', 'fecha']) &&
          request.resource.data.userId == request.auth.uid &&
          isValidRating();
          
        allow update: if isAuthenticated() && isEmailVerified() &&
          ratingId == request.auth.uid &&
          request.resource.data.userId == request.auth.uid &&
          resource.data.userId == request.auth.uid &&
          isValidRating();
          
        // Solo el dueño del rating o un admin pueden borrarlo
        allow delete: if isAuthenticated() &&
          (ratingId == request.auth.uid || isAdmin());
      }
    }

    // ----- USERS -----
    match /users/{uid} {
      // El dueño puede leer/escribir su documento
      // Los administradores pueden leer todos los usuarios y modificar roles
      allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && (request.auth.uid == uid || isAdmin());
      allow delete: if request.auth != null && request.auth.uid == uid;

      // Validación simple de esquema (evita tipos raros)
      function isValidUser(data) {
        return
          (data.keys().hasOnly([
            'uid','email','displayName','photoURL','nombre','apodo',
            'fechaNacimiento','region','comuna','activo','createdAt','updatedAt','role'
          ])) &&
          (data.uid is string) &&
          (data.email is string) &&
          (data.displayName is string || data.displayName == null) &&
          (data.photoURL is string || data.photoURL == null) &&
          (data.nombre is string || data.nombre == null) &&
          (data.apodo is string || data.apodo == null) &&
          (data.fechaNacimiento is string || data.fechaNacimiento == null) &&
          (data.region is string || data.region == null) &&
          (data.comuna is string || data.comuna == null) &&
          (data.activo is bool || data.activo == null) &&
          (data.role is string || data.role == null);
      }

      allow create: if request.auth != null
                    && request.auth.uid == uid
                    && isValidUser(request.resource.data);

      allow update: if request.auth != null
                    && isValidUser(request.resource.data)
                    && (
                      // El usuario puede actualizar su propio perfil (excepto role)
                      (request.auth.uid == uid && 
                       (request.resource.data.role == resource.data.role || request.resource.data.role == null)) ||
                      // Los administradores pueden cambiar cualquier rol
                      isAdmin()
                    )
                    // No permitir que el cliente cambie createdAt
                    && (request.resource.data.createdAt == resource.data.createdAt);

      // ----- ESTACIONES VISITADAS (subcollection) -----
      match /estaciones_visitadas/{estacionVisitadaId} {
        // Solo el dueño puede leer/escribir sus estaciones visitadas
        allow read, create, update, delete: if request.auth != null && request.auth.uid == uid;

        // Validación de esquema para estaciones visitadas
        function isValidEstacionVisitada(data) {
          return
            (data.keys().hasOnly([
              'id', 'estacionId', 'estacionCodigo', 'estacionNombre',
              'fechaVisita', 'latitudVisita', 'longitudVisita'
            ])) &&
            (data.id is string) &&
            (data.estacionId is string) &&
            (data.estacionCodigo is string) &&
            (data.estacionNombre is string) &&
            (data.fechaVisita is timestamp) &&
            (data.latitudVisita is number || data.latitudVisita == null) &&
            (data.longitudVisita is number || data.longitudVisita == null);
        }

        allow create: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidEstacionVisitada(request.resource.data);
        
        allow update: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidEstacionVisitada(request.resource.data);
      }

      // ----- INSIGNIAS POR USUARIO (subcollection) -----
      // Permite que el propio usuario o un administrador creen/lean las insignias
      match /insignias/{insigniaId} {
        // Validación simple para el documento de insignia del usuario
        function isValidUserInsignia(data) {
          // Validamos únicamente la presencia de fechaObtenida (timestamp).
          // No comprobamos el tipo de `estacionRef` porque el tipo `reference`
          // puede causar errores de análisis en algunos entornos de reglas.
          return (
            data.keys().hasOnly(['fechaObtenida']) ||
            data.keys().hasOnly(['fechaObtenida','estacionRef'])
          )
          && (data.fechaObtenida is timestamp);
        }

        // Lectura: dueño o admin
        allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());

        // Crear: dueño o admin
        allow create: if request.auth != null
                      && (request.auth.uid == uid || isAdmin())
                      && isValidUserInsignia(request.resource.data);

        // Update/Delete: dueño o admin
        allow update, delete: if request.auth != null && (request.auth.uid == uid || isAdmin());
      }

      // ----- FOTOS DEL ÁLBUM (subcollection) -----
      match /album_photos/{photoId} {
        // Validación de esquema para fotos del álbum
        function isValidAlbumPhoto(data) {
          return
            (data.keys().hasOnly([
              'id', 'badgeId', 'imageUrl', 'thumbnailUrl', 'description',
              'uploadDate', 'location', 'metadata'
            ])) &&
            (data.id is string) &&
            (data.badgeId is string) &&
            (data.imageUrl is string) &&
            (data.thumbnailUrl is string || data.thumbnailUrl == null) &&
            (data.description is string || data.description == null) &&
            (data.uploadDate is timestamp) &&
            (data.location is string || data.location == null) &&
            (data.metadata is map || data.metadata == null);
        }

        // Solo el dueño puede leer/escribir sus fotos del álbum con validación
        allow read: if request.auth != null && request.auth.uid == uid;
        allow create: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidAlbumPhoto(request.resource.data);
        allow update: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidAlbumPhoto(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == uid;
      }
    }

    // ----- PLACES (legacy) -----
    // Mantener reglas para compatibilidad con documentos históricos bajo 'places'.
    match /places/{placeId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;
    }

    // ----- INSIGNIAS -----
    // Colección de insignias (top-level)
    match /insignias/{insigniaId} {
      function isValidInsignia(data) {
        return data.keys().hasOnly(['nombre','descripcion','imagenUrl','fechaCreacion'])
               && (data.nombre is string)
               && (data.descripcion is string)
               && (data.imagenUrl is string)
               && (data.fechaCreacion is timestamp);
      }

      // Lectura: cualquiera autenticado puede leer la lista de insignias
      allow read: if request.auth != null;

      // Crear/Actualizar/Borrar: solo administradores
      allow create: if request.auth != null && isAdmin() && isValidInsignia(request.resource.data);
      allow update, delete: if request.auth != null && isAdmin();
    }

    // No necesitamos esta sección duplicada ya que las reglas de estaciones 
    // están definidas arriba
  }
}
