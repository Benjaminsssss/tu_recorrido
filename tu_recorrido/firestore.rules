// DEV - firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----- USERS -----
    match /users/{uid} {
      // Solo el dueño puede leer/escribir su documento
      allow read, create, update, delete: if request.auth != null && request.auth.uid == uid;

      // Validación simple de esquema (evita tipos raros)
      function isValidUser(data) {
        return
          (data.keys().hasOnly([
            'uid','email','displayName','photoURL','nombre','apodo',
            'fechaNacimiento','region','comuna','activo','createdAt','updatedAt'
          ])) &&
          (data.uid is string) &&
          (data.email is string) &&
          (data.displayName is string || data.displayName == null) &&
          (data.photoURL is string || data.photoURL == null) &&
          (data.nombre is string || data.nombre == null) &&
          (data.apodo is string || data.apodo == null) &&
          (data.fechaNacimiento is string || data.fechaNacimiento == null) &&
          (data.region is string || data.region == null) &&
          (data.comuna is string || data.comuna == null) &&
          (data.activo is bool || data.activo == null);
      }

      allow create: if request.auth != null
                    && request.auth.uid == uid
                    && isValidUser(request.resource.data);

      allow update: if request.auth != null
                    && request.auth.uid == uid
                    && isValidUser(request.resource.data)
                    // No permitir que el cliente cambie createdAt
                    && (request.resource.data.createdAt == resource.data.createdAt);

      allow read, delete: if request.auth != null && request.auth.uid == uid;

      // ----- ESTACIONES VISITADAS (subcollection) -----
      match /estaciones_visitadas/{estacionVisitadaId} {
        // Solo el dueño puede leer/escribir sus estaciones visitadas
        allow read, create, update, delete: if request.auth != null && request.auth.uid == uid;

        // Validación de esquema para estaciones visitadas
        function isValidEstacionVisitada(data) {
          return
            (data.keys().hasOnly([
              'id', 'estacionId', 'estacionCodigo', 'estacionNombre',
              'fechaVisita', 'latitudVisita', 'longitudVisita'
            ])) &&
            (data.id is string) &&
            (data.estacionId is string) &&
            (data.estacionCodigo is string) &&
            (data.estacionNombre is string) &&
            (data.fechaVisita is timestamp) &&
            (data.latitudVisita is number || data.latitudVisita == null) &&
            (data.longitudVisita is number || data.longitudVisita == null);
        }

        allow create: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidEstacionVisitada(request.resource.data);
        
        allow update: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidEstacionVisitada(request.resource.data);
      }
    }

    // ----- PLACES -----
    // (DEV) cualquiera autenticado puede leer; crear/borrar/editar si está autenticado.
    match /places/{placeId} {
      allow read: if true; // público (puedes cambiarlo si quieres)
      allow create, update, delete: if request.auth != null;
    }

    // ----- ESTACIONES -----
    // Estaciones patrimoniales para escaneo QR
    match /estaciones/{estacionId} {
      // Lectura pública para usuarios autenticados (escaneo QR)
      allow read: if request.auth != null;
      
      // Solo usuarios autenticados pueden crear/actualizar estaciones
      // En producción, esto debería restringirse solo a administradores
      allow create, update: if request.auth != null;
      
      // Solo administradores pueden eliminar (implementar role-based después)
      allow delete: if request.auth != null;

      // Validación de esquema para estaciones
      function isValidEstacion(data) {
        return
          (data.keys().hasOnly([
            'codigo', 'codigoQR', 'nombre', 'descripcion', 
            'latitud', 'longitud', 'fechaCreacion', 'activa'
          ])) &&
          (data.codigo is string) &&
          (data.codigoQR is string) &&
          (data.nombre is string) &&
          (data.descripcion is string) &&
          (data.latitud is number) &&
          (data.longitud is number) &&
          (data.fechaCreacion is timestamp) &&
          (data.activa is bool);
      }

      allow create: if request.auth != null && isValidEstacion(request.resource.data);
      allow update: if request.auth != null && isValidEstacion(request.resource.data);
    }
  }
}
