rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- FUNCIONES GLOBALES ---
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    // Función para verificar si un usuario es administrador
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Función para validar el valor del rating
    function isValidRating() {
      return request.resource.data.rating is number &&
             request.resource.data.rating >= 0 &&
             request.resource.data.rating <= 5;
    }

    // --- COLECCIÓN: USERS ---
    match /users/{uid} {
      // Reglas básicas (Lectura/Escritura)
      allow read: if isAuthenticated() && (request.auth.uid == uid || isAdmin());
      allow delete: if request.auth != null && request.auth.uid == uid;

      // Validación de esquema para el documento user
      function isValidUser(data) {
        return
          (data.keys().hasOnly([
            'uid','email','displayName','photoURL','nombre','apodo',
            'fechaNacimiento','region','comuna','activo','createdAt','updatedAt','role'
          ])) &&
          (data.uid is string) &&
          (data.email is string) &&
          (data.displayName is string || data.displayName == null) &&
          (data.photoURL is string || data.photoURL == null) &&
          (data.nombre is string || data.nombre == null) &&
          (data.apodo is string || data.apodo == null) &&
          (data.fechaNacimiento is string || data.fechaNacimiento == null) &&
          (data.region is string || data.region == null) &&
          (data.comuna is string || data.comuna == null) &&
          (data.activo is bool || data.activo == null) &&
          (data.role is string || data.role == null);
      }

      // Creación: Sólo el propio usuario puede crearse y debe pasar validación
      allow create: if isAuthenticated()
                       && request.auth.uid == uid
                       && isValidUser(request.resource.data);

      // Actualización: Debe pasar validación y ser dueño o admin.
      allow update: if isAuthenticated()
                       && isValidUser(request.resource.data)
                       && (
                         // DUEÑO: Puede actualizar su perfil, PERO no cambiar el 'role' (o establecerlo como null)
                         (request.auth.uid == uid &&
                          (request.resource.data.role == resource.data.role || request.resource.data.role == null))
                         // ADMIN: Puede cambiar todo
                         || isAdmin()
                       )
                       // No permitir que el cliente cambie 'createdAt'
                       && (request.resource.data.createdAt == resource.data.createdAt);


      // --- SUBCOLECCIÓN: estaciones_visitadas ---
      match /estaciones_visitadas/{estacionVisitadaId} {
        // Validación de esquema para estaciones visitadas
        function isValidEstacionVisitada(data) {
          return
            (data.keys().hasOnly([
              'id', 'estacionId', 'estacionCodigo', 'estacionNombre',
              'fechaVisita', 'latitudVisita', 'longitudVisita'
            ])) &&
            (data.id is string) &&
            (data.estacionId is string) &&
            (data.estacionCodigo is string) &&
            (data.estacionNombre is string) &&
            (data.fechaVisita is timestamp) &&
            (data.latitudVisita is number || data.latitudVisita == null) &&
            (data.longitudVisita is number || data.longitudVisita == null);
        }

        // Solo el dueño puede leer/escribir sus estaciones visitadas
        allow read, create, update, delete: if isAuthenticated() && request.auth.uid == uid;

        allow create: if isAuthenticated()
                       && request.auth.uid == uid
                       && isValidEstacionVisitada(request.resource.data);

        allow update: if isAuthenticated()
                       && request.auth.uid == uid
                       && isValidEstacionVisitada(request.resource.data);
      }

      // --- SUBCOLECCIÓN: insignias ---
      match /insignias/{insigniaId} {
        // Validación simple para el documento de insignia del usuario
        function isValidUserInsignia(data) {
          return (
            data.keys().hasOnly(['fechaObtenida']) ||
            data.keys().hasOnly(['fechaObtenida','estacionRef'])
          )
          && (data.fechaObtenida is timestamp);
        }

        // Lectura: dueño o admin
        allow read: if isAuthenticated() && (request.auth.uid == uid || isAdmin());

        // Crear: dueño o admin, y debe pasar validación de esquema
        allow create: if isAuthenticated()
                       && (request.auth.uid == uid || isAdmin())
                       && isValidUserInsignia(request.resource.data);

        // Update/Delete: dueño o admin
        allow update, delete: if isAuthenticated() && (request.auth.uid == uid || isAdmin());
      }

      // --- SUBCOLECCIÓN: album_photos ---
      match /album_photos/{photoId} {
        // Validación de esquema para fotos del álbum
        function isValidAlbumPhoto(data) {
          return
            (data.keys().hasOnly([
              'id', 'badgeId', 'imageUrl', 'thumbnailUrl', 'description',
              'uploadDate', 'location', 'metadata'
            ])) &&
            (data.id is string) &&
            (data.badgeId is string) &&
            (data.imageUrl is string) &&
            (data.thumbnailUrl is string || data.thumbnailUrl == null) &&
            (data.description is string || data.description == null) &&
            (data.uploadDate is timestamp) &&
            (data.location is string || data.location == null) &&
            (data.metadata is map || data.metadata == null);
        }

        // Solo el dueño puede leer/escribir sus fotos del álbum con validación
        allow read: if isAuthenticated() && request.auth.uid == uid;

        allow create: if isAuthenticated()
                       && request.auth.uid == uid
                       && isValidAlbumPhoto(request.resource.data);

        allow update: if isAuthenticated()
                       && request.auth.uid == uid
                       && isValidAlbumPhoto(request.resource.data);

        allow delete: if isAuthenticated() && request.auth.uid == uid;
      }

      // ----- FOTOS DEL ÁLBUM (subcollection) -----
      match /album_photos/{photoId} {
        // Validación de esquema para fotos del álbum
        function isValidAlbumPhoto(data) {
          return
            (data.keys().hasOnly([
              'id', 'badgeId', 'imageUrl', 'thumbnailUrl', 'description',
              'uploadDate', 'location', 'metadata'
            ])) &&
            (data.id is string) &&
            (data.badgeId is string) &&
            (data.imageUrl is string) &&
            (data.thumbnailUrl is string || data.thumbnailUrl == null) &&
            (data.description is string || data.description == null) &&
            (data.uploadDate is timestamp) &&
            (data.location is string || data.location == null) &&
            (data.metadata is map || data.metadata == null);
        }

        // Solo el dueño puede leer/escribir sus fotos del álbum con validación
        allow read: if request.auth != null && request.auth.uid == uid;
        allow create: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidAlbumPhoto(request.resource.data);
        allow update: if request.auth != null 
                      && request.auth.uid == uid 
                      && isValidAlbumPhoto(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == uid;
      }
    }

    // --- COLECCIÓN: PLACES (legado) ---
    match /places/{placeId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated();
    }

    // --- COLECCIÓN: INSIGNIAS (top-level) ---
    match /insignias/{insigniaId} {
      function isValidInsignia(data) {
        return data.keys().hasOnly(['nombre','descripcion','imagenUrl','fechaCreacion'])
               && (data.nombre is string)
               && (data.descripcion is string)
               && (data.imagenUrl is string)
               && (data.fechaCreacion is timestamp);
      }

      // Lectura: cualquiera autenticado puede leer la lista de insignias
      allow read: if isAuthenticated();

      // Crear/Actualizar/Borrar: solo administradores
      allow create: if isAdmin() && isValidInsignia(request.resource.data);
      allow update, delete: if isAdmin();
    }

    // --- COLECCIÓN: ESTACIONES ---
    match /estaciones/{estacionId} {

      // Validación de esquema para estaciones
      function isValidEstacion(data) {
        // Aceptar dos variantes de keys: con o sin `insigniaID` (es opcional)
        return (
          data.keys().hasOnly([
            'codigo', 'codigoQR', 'nombre', 'descripcion',
            'latitud', 'longitud', 'fechaCreacion', 'activa', 'rating', 'totalRatings', 'updatedAt'
          ])
        ||
          data.keys().hasOnly([
            'codigo', 'codigoQR', 'nombre', 'descripcion',
            'latitud', 'longitud', 'fechaCreacion', 'activa', 'insigniaID', 'rating', 'totalRatings', 'updatedAt'
          ])
        )
        && (data.codigo is string)
        && (data.codigoQR is string)
        && (data.nombre is string)
        && (data.descripcion is string)
        && (data.latitud is number)
        && (data.longitud is number)
        && (data.fechaCreacion is timestamp)
        && (data.activa is bool)
        // Añadir validación de tipos para los campos de rating
        && (data.rating is number)
        && (data.totalRatings is number)
        && (data.updatedAt is timestamp);
      }

      // Cualquiera autenticado puede leer las estaciones
      allow read: if isAuthenticated();

      // Creación: Solo administradores y pasa validación
      allow create: if isAdmin()
                       && isValidEstacion(request.resource.data)
                       // en creación, solo permitir insigniaID si es null o el creador es admin
                       && (request.resource.data.insigniaID == null || isAdmin());

      // Actualización: Solo campos de rating (para el público) o ser admin
      allow update: if isAuthenticated() &&
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['rating', 'totalRatings', 'updatedAt'])
          // Si no está actualizando solo el rating, debe ser un administrador
          || isAdmin()
        );

      // Borrar: Solo administradores
      allow delete: if isAdmin();

      // --- SUBCOLECCIÓN: ratings ---
      match /ratings/{ratingId} {
        // Cualquiera puede ver los ratings
        allow read: if true;

        // Solo usuarios autenticados y verificados pueden crear/actualizar su propio rating
        allow create: if isAuthenticated() && isEmailVerified() &&
          ratingId == request.auth.uid &&
          request.resource.data.keys().hasAll(['rating', 'userId', 'fecha']) &&
          request.resource.data.userId == request.auth.uid &&
          isValidRating();

        allow update: if isAuthenticated() && isEmailVerified() &&
          ratingId == request.auth.uid &&
          request.resource.data.userId == request.auth.uid &&
          resource.data.userId == request.auth.uid &&
          isValidRating();

        // Solo el dueño del rating o un admin pueden borrarlo
        allow delete: if isAuthenticated() &&
          (ratingId == request.auth.uid || isAdmin());
      }
    }
  }
}