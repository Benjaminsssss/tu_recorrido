// DEV - firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----- USERS -----
    match /users/{uid} {
      // Solo el dueño puede leer/escribir su documento
      allow read, create, update, delete: if request.auth != null && request.auth.uid == uid;

      // Validación simple de esquema (evita tipos raros)
      function isValidUser(data) {
        return
          (data.keys().hasOnly([
            'uid','email','displayName','photoURL','nombre','apodo',
            'fechaNacimiento','region','comuna','activo','createdAt','updatedAt'
          ])) &&
          (data.uid is string) &&
          (data.email is string) &&
          (data.displayName is string || data.displayName == null) &&
          (data.photoURL is string || data.photoURL == null) &&
          (data.nombre is string || data.nombre == null) &&
          (data.apodo is string || data.apodo == null) &&
          (data.fechaNacimiento is string || data.fechaNacimiento == null) &&
          (data.region is string || data.region == null) &&
          (data.comuna is string || data.comuna == null) &&
          (data.activo is bool || data.activo == null);
      }

      allow create: if request.auth != null
                    && request.auth.uid == uid
                    && isValidUser(request.resource.data);

      allow update: if request.auth != null
                    && request.auth.uid == uid
                    && isValidUser(request.resource.data)
                    // No permitir que el cliente cambie createdAt
                    && (request.resource.data.createdAt == resource.data.createdAt);

      allow read, delete: if request.auth != null && request.auth.uid == uid;
    }

    // ----- ESTACIONES (antes "places") -----
    // (DEV) cualquiera autenticado puede leer; crear/borrar/editar si está autenticado.
    match /estaciones/{placeId} {
      allow read: if true; // público (puedes cambiarlo si quieres)
      allow create, update, delete: if request.auth != null;
    }
  }
}
